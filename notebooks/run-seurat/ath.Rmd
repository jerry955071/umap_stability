---
title: "Seurat preprocessing"
author:
    - "Chia-Chen Chu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
    
editor_options: 
  markdown: 
    wrap: 72
---

NOTE: Run with docker image chiaenu/seurat-rmd:5.0.0

# Input data

Gene expression matrix `GSM5591756_Seurat_dedoublet.rds.gz` were
downloaded from NCBI GEO as
`data/ath/GSM5591756_Seurat_dedoublet.rds.gz`. This file is the "Seurat
rds object of SCTransformed and normalized data using Seurat v3.0" as
noted by the author.

    wget https://ftp.ncbi.nlm.nih.gov/geo/samples/GSM5591nnn/GSM5591756/suppl/GSM5591756%5FSeurat%5Fdedoublet.rds.gz && \
      mv GSM5591756_Seurat_dedoublet.rds.gz data/ath/

Extract data using `gunzip` gives this file:
`GSM5591756_Seurat_dedoublet.rds`

# Setups

Import libraries

```{r}
library(Seurat)
library(magrittr)
```

Set args

```{r}
sample_name <- "ath"
input_file <- sprintf("data/ath/GSM5591756_Seurat_dedoublet.rds")
output_dir <- sprintf("outputs/Seurat/%s", sample_name)

# create output directory
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE) 

# setup output file paths
path_rdata <- file.path(output_dir, "seurat_obj.rds") 
path_pca <- file.path(output_dir, "pca.csv") 
path_clusters <- file.path(output_dir, "clusters.csv")
```

# Analysis

Read data

```{r}
seurat_obj <- readRDS(input_file) %>% UpdateSeuratObject
seurat_obj
```

Normalize data with sctransform

```{r}
VariableFeaturePlot(seurat_obj)
```

Elbow plot

```{r}
ElbowPlot(seurat_obj, ndims = 100, reduction = "pca")
```

Clustering

```{r}
table(seurat_obj$seurat_clusters)
```

# Export data

```{r}
write.csv(
  Embeddings(seurat_obj, reduction = "pca")[, 1:npcs], 
  file = path_pca, 
  quote = FALSE
)
write.csv(
  Idents(seurat_obj) %>% as.data.frame,
  file = path_clusters,
  quote = FALSE
)
```

Print the commands used by the authors to create this Seurat object

```{r}
seurat_obj@commands
```

Print session info 

```{r}
sessionInfo()
```