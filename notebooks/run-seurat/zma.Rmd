---
title: "Seurat preprocessing"
author:
    - "Chia-Chen Chu"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  highlight: tango
  number_sections: no
  theme: default
  toc: yes
  toc_depth: 3
  toc_float:
    collapsed: no
    smooth_scroll: yes
    
editor_options: 
  markdown: 
    wrap: 72
---

NOTE: Run with docker image chiaenu/seurat-rmd:5.0.0

# Input data

Gene expression matrix `GSE247571_singlecell_raw_counts.matrix.txt.gz`
were downloaded from NCBI GEO to `data/zma`

Data is downloaded via the following command:

    wget https://ftp.ncbi.nlm.nih.gov/geo/series/GSE247nnn/GSE247571/suppl/GSE247571%5Fsinglecell%5Fraw%5Fcounts.matrix.txt.gz && \
      mv GSE247571_singlecell_raw_counts.matrix.txt.gz data/zma/

# Setups

Import libraries

```{r}
library(Seurat)
library(magrittr)
```

Set args

```{r}
sample_name <- "zma"

# input files
input_file <- "data/zma/GSE247571_singlecell_raw_counts.matrix.txt.gz"
published_marker_genes <- "data/zma/primary_cluster_marker.tsv"
output_dir <- file.path("outputs/Seurat/%s", sample_name)

# create output directory
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE) 

# setup output file paths
path_rdata <- file.path(output_dir, "seurat_obj.rds") 
path_pca <- file.path(output_dir, "pca.csv") 
path_clusters <- file.path(output_dir, "clusters.csv")
```

# Analysis

Read data

```{r}
con <- file(input_file)
hline <- readLines(con = con, n = 1)
close(con)
col_names <- strsplit(hline, ",")[[1]]
col_names[1:10]
```

Identify FM-S2 rep1 cells

(based on [Supplementary Table
2](https://www.cell.com/cms/10.1016/j.molp.2024.06.007/attachment/ea22ee4b-1a75-4e3d-93fb-8d9f7517b7bb/mmc3.xlsx) -
Sheet 1 quality control of scRNA - Qualified cells)

```{r}
cells <- col_names[2:length(col_names)]
bios <- cells %>% sapply(function(x){
    foo <- strsplit(x, "_")[[1]]
    return(paste(foo[1], foo[2], foo[3], sep = "_"))
  })
table(bios)
```

Subset gene expression of FM-S2 rep1 cells

```{r}
# get columns of FM-S2 rep1 cells
selected_columns <- col_names %>% grep("E1_e1_1", ., value = TRUE)
selected_columns <- append(col_names[1], selected_columns)

# read only FM-S2 rep1 cells
df <- data.table::fread(input_file, sep = ",", select = selected_columns)

# convert to matrix
geneid <- df$Geneid
mtx <- df[,2:ncol(df)] %>% as.matrix()
rownames(mtx) <- geneid
```

Create Seurat object

```{r}
seurat_obj <- CreateSeuratObject(mtx)
seurat_obj
```

Normalize data with sctransform

```{r}
seurat_obj <- SCTransform(seurat_obj, variable.features.n = 2000)
VariableFeaturePlot(seurat_obj)
```

Calculate scoring for cell cycle genes

```{r}
cell_cycle_gene <- read.table(
  "data/zma/regress_cell_cycle.tsv",
  sep = "\t",
  header = TRUE
)
s.genes <- subset(cell_cycle_gene, cell_cycle_gene$type == "S phase")$gene.ID
g2m.genes <- subset(cell_cycle_gene, cell_cycle_gene$type == "G2/M phase")$gene.ID
seurat_obj %<>% CellCycleScoring(
  s.features = s.genes,
  g2m.features = g2m.genes,
  set.ident = TRUE
)
```

Calculate module scores for protoplasting-induced genes

```{r}
protoplast_gene <- read.table(
  "data/zma/merge_protoplasting_gene.tsv",
  sep = "\t",
  header = TRUE
)
detected_protoplasting_gene <- intersect(
  protoplast_gene$gene.ID,
  Features(seurat_obj)
)
seurat_obj %<>% AddModuleScore(
  features = list(c(detected_protoplasting_gene)),
  name = "Protoplasting"
)
```

```{r}
seurat_obj <- SCTransform(
  seurat_obj,
  variable.features.n = 2000, 
  vars.to.regress = c("S.Score", "G2M.Score", "Protoplasting1")
)
VariableFeaturePlot(seurat_obj)
```

Run PCA

```{r}
seurat_obj <- RunPCA(seurat_obj, npcs = 100, verbose = TRUE)
ElbowPlot(seurat_obj, ndims = 100, reduction = "pca")
```

Set the number of PC for downstream analyses

```{r}
npcs <- 15
```

Clustering

-   Adjust the clustering resolution so that the number of clusters
    matches those in the original study

-   Match cluster number to that of the original study using the Jaccard
    index

    ```{r}
    JaccardIndex <- function(a, b){length(intersect(a, b)) / length(union(a, b))}
    ```

```{r}
markers.published <- read.csv("data/zma/sub_cluster_marker.tsv", sep = "\t")
markers_fig4 <- markers.published[, c("geneID", "cluster", "gene.for.identity.in.Fig..4")] %>% dplyr::distinct(geneID, .keep_all = TRUE)
markers_fig4
```

```{r}
seurat_obj <- FindNeighbors(seurat_obj, reduction = "pca", dims = 1:npcs)
seurat_obj <- FindClusters(seurat_obj, resolution = .4)
table(seurat_obj$seurat_clusters)
```

Plot expression of marker genes

```{r}
DotPlot(
  seurat_obj, 
  features = markers_fig4$geneID %>% rev
) + 
  RotatedAxis() + 
  ggplot2::coord_flip()
```

UMAP visualization

```{r}
seurat_obj <- RunUMAP(
  seurat_obj, 
  dims = 1:npcs
)
DimPlot(seurat_obj)
```

# Export data

```{r}
saveRDS(seurat_obj, file = path_rdata)
write.csv(
  Embeddings(seurat_obj, reduction = "pca")[, 1:npcs], 
  file = path_pca, 
  quote = FALSE
)
write.csv(
  Idents(seurat_obj) %>% as.data.frame,
  file = path_clusters,
  quote = FALSE
)
```

Print session info

```{r}
sessionInfo()
```
